{% extends 'dashboard/base.html' %}
{% block content %}
<div class="container mt-4">
    <h3>{% if product %}Edit{% else %}Add{% endif %} Product</h3>
    <form method="post" enctype="multipart/form-data">
        {% csrf_token %}
        {{ form.as_p }}

        <h5>Product Images</h5>
        {{ image_formset.management_form }}
        <div id="image-formset">
            {% for form in image_formset %}
                <div class="mb-2 border p-2">
                    {{ form.image.label_tag }} {{ form.image }}
                    {{ form.alt_text.label_tag }} {{ form.alt_text }}
                    {{ form.is_main.label_tag }} {{ form.is_main }}
                    {% if form.DELETE %} {{ form.DELETE }} Delete {% endif %}
                </div>
            {% endfor %}
        </div>
        <button type="button" class="btn btn-sm btn-info mb-3" onclick="addForm('image')">+ Add More Image</button>

        <h5>Variants</h5>
        {{ variant_formset.management_form }}
        <div id="variant-formset">
            {% for form in variant_formset %}
                <div class="mb-2 border p-2">
                    {{ form.name.label_tag }} {{ form.name }}
                    {{ form.value.label_tag }} {{ form.value }}
                    {{ form.price.label_tag }} {{ form.price }}
                    {{ form.stock.label_tag }} {{ form.stock }}
                    {% if form.DELETE %} {{ form.DELETE }} Delete {% endif %}
                </div>
            {% endfor %}
        </div>
        <button type="button" class="btn btn-sm btn-info mb-3" onclick="addForm('variant')">+ Add More Variant</button>

        <br>
        <button type="submit" class="btn btn-success">Save</button>
    </form>
</div>

<script>
function addForm(type){
    let formset, totalFormsInput, prefix;

    if(type === 'image'){
        formset = document.getElementById('image-formset');
        totalFormsInput = document.getElementById('id_' + '{{ image_formset.prefix }}-TOTAL_FORMS');
        prefix = '{{ image_formset.prefix }}';
    } else {
        formset = document.getElementById('variant-formset');
        totalFormsInput = document.getElementById('id_' + '{{ variant_formset.prefix }}-TOTAL_FORMS');
        prefix = '{{ variant_formset.prefix }}';
    }

    let totalForms = parseInt(totalFormsInput.value);
    let newForm = formset.children[0].cloneNode(true);

    // Clear all input values
    newForm.querySelectorAll('input, select, textarea').forEach(input => {
        if(input.type === 'checkbox' || input.type === 'radio') input.checked = false;
        else input.value = '';
    });

    // Update name and id attributes
    newForm.querySelectorAll('*').forEach(el => {
        if(el.hasAttribute('name')){
            el.name = el.name.replace(/-\d+-/, '-' + totalForms + '-');
        }
        if(el.hasAttribute('id')){
            el.id = el.id.replace(/-\d+-/, '-' + totalForms + '-');
        }
    });

    formset.appendChild(newForm);
    totalFormsInput.value = totalForms + 1;
}
</script>

{% endblock %}
